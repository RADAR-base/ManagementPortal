<?xml version="1.0" encoding="utf-8"?>
<!--
  ~ Copyright (c) 2017. The Hyve and respective contributors
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~
  ~ See the file LICENSE in the root of this repository.
  ~
  -->
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="now" value="now()" dbms="mysql,hsqldb"/>
	<property name="now" value="current_timestamp" dbms="postgresql"/>
	<property name="now" value="sysdate" dbms="oracle"/>
	<property name="now" value="GETDATE()" dbms="mssql"/>
	<property name="autoIncrement" value="true" dbms="mysql,h2,postgresql,oracle,mssql"/>
	<property name="floatType" value="float4" dbms="postgresql,hsqldb"/>
	<property name="floatType" value="float" dbms="mysql, oracle, mssql"/>
	<!-- query_group -->
	<changeSet id="20250215215500" author="Henry">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="query_group"/>
			</not>
		</preConditions>
		<createTable tableName="query_group">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(1000)"/>
			<column name="created_date" type="timestamp" defaultValueDate="${now}">
				<constraints nullable="false"/>
			</column>
			<column name="updated_date" type="timestamp" defaultValueDate="${now}"/>
			<column name="created_by" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="updated_by" type="varchar(250)"/>
		</createTable>
	</changeSet>
	<changeSet id="fk-query_group-created_by" author="Gwen">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="fk_query_group_created_by"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseColumnNames="created_by"
                                 baseTableName="query_group"
                                 constraintName="fk_query_group_created_by"
                                 referencedColumnNames="id"
                                 referencedTableName="radar_user"/>
	</changeSet>
	<!-- query -->
	<changeSet id="create-query" author="Henry">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="query"/>
			</not>
		</preConditions>
		<createTable tableName="query">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="query_group_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="entity" type="varchar(255)">
				<constraints nullable="true" />
			</column>
			<column name="query_metric" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="comparison_operator" type="varchar(32)">
				<constraints nullable="false" />
			</column>
			<column name="value" type="varchar(250)">
				<constraints nullable="false"/>
			</column>
			<column name="time_frame" type="varchar(32)">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	<changeSet id="fk-query-query_group" author="Gwen">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="fk_query_query_group_id"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseColumnNames="query_group_id"
                                 baseTableName="query"
                                 constraintName="fk_query_query_group_id"
                                 referencedColumnNames="id"
                                 referencedTableName="query_group"/>
	</changeSet>
	<!-- query_logic -->
	<changeSet id="create-query_logic" author="Gwen">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="query_logic"/>
			</not>
		</preConditions>
		<createTable tableName="query_logic">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="query_group_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="type" type="varchar(32)">
				<constraints nullable="false" />
			</column>
			<column name="logic_operator" type="varchar(32)"/>
			<column name="query_id" type="bigint"/>
			<column name="parent_id" type="bigint"/>
		</createTable>
	</changeSet>
	<changeSet id="fk-query_logic-group-parent" author="Gwen">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="fk_query_logic_query_group_id"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseColumnNames="query_group_id"
                                 baseTableName="query_logic"
                                 constraintName="fk_query_logic_query_group_id"
                                 referencedColumnNames="id"
                                 referencedTableName="query_group"/>
		<addForeignKeyConstraint baseColumnNames="parent_id"
                                 baseTableName="query_logic"
                                 constraintName="fk_query_logic_parent_id"
                                 referencedColumnNames="id"
                                 referencedTableName="query_logic"/>
	</changeSet>
	<!-- query_participant -->
	<changeSet id="create-query_participant" author="Gwen">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="query_participant"/>
			</not>
		</preConditions>
		<createTable tableName="query_participant">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="query_group_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="subject_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="created_date" type="timestamp" defaultValueDate="${now}">
				<constraints nullable="false"/>
			</column>
			<column name="updated_date" type="timestamp" defaultValueDate="${now}"/>
			<column name="created_by" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	<changeSet id="fk-query_participant-all" author="Gwen">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="fk_query_participant_query_group_id"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseColumnNames="query_group_id"
                                 baseTableName="query_participant"
                                 constraintName="fk_query_participant_query_group_id"
                                 referencedColumnNames="id"
                                 referencedTableName="query_group"/>
		<addForeignKeyConstraint baseColumnNames="subject_id"
                                 baseTableName="query_participant"
                                 constraintName="fk_query_participant_subject_id"
                                 referencedColumnNames="id"
                                 referencedTableName="subject"/>
		<addForeignKeyConstraint baseColumnNames="created_by"
                                 baseTableName="query_participant"
                                 constraintName="fk_query_participant_created_by"
                                 referencedColumnNames="id"
                                 referencedTableName="radar_user"/>
	</changeSet>
	<!--query evaluation-->
	<changeSet id="create_query_evaluation" author="Henry">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="query_evaluation"/>
			</not>
		</preConditions>
		<createTable tableName="query_evaluation">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="query_group_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="created_date" type="timestamp" defaultValueDate="${now}">
				<constraints nullable="false"/>
			</column>
			<column name="updated_date" type="timestamp">
				<constraints nullable="true"/>
			</column>
			<column name="subject_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="result" type="boolean" >
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	<changeSet id="fk-query_evaluation" author="Henry">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="fk_query_evaluation_subject_id"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseColumnNames="subject_id"
                                 baseTableName="query_evaluation"
                                 constraintName="fk_query_evaluation_subject_id"
                                 referencedColumnNames="id"
                                 referencedTableName="subject"/>
	</changeSet>
	<!--query content group table-->
	<changeSet id="create-query_content_group" author="Gwen">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="query_content_group"/>
			</not>
		</preConditions>
		<createTable tableName="query_content_group">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="content_group_name" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="query_group_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="created_date" type="timestamp" defaultValueDate="${now}">
				<constraints nullable="false"/>
			</column>
			<column name="updated_date" type="timestamp">
				<constraints nullable="true"/>
			</column>
		</createTable>
		<addForeignKeyConstraint baseColumnNames="query_group_id"
								baseTableName="query_content_group"
								constraintName="fk_query_content_group_query_group_id"
								referencedColumnNames="id"
								referencedTableName="query_group"/>
	</changeSet>
	<!--query content-->
	<changeSet id="create-query_content" author="Henry">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="query_content"/>
			</not>
		</preConditions>
		<createTable tableName="query_content">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="type" type="varchar(255)">
				<constraints nullable="true" />
			</column>
			<column name="heading" type="TEXT">
				<constraints nullable="true" />
			</column>
			<column name="text_value" type="TEXT">
				<constraints nullable="true" />
			</column>
			<column name="image" type="BYTEA">
				<constraints nullable="true" />
			</column>
			<column name="query_group_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="query_content_group_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="image_alternative_text" type="varchar(255)">
				<constraints nullable="true" />
			</column>
		</createTable>
		<addForeignKeyConstraint baseColumnNames="query_group_id"
								baseTableName="query_content"
								constraintName="fk_query_content_query_group_id"
								referencedColumnNames="id"
								referencedTableName="query_group"/>
		<addForeignKeyConstraint baseColumnNames="query_content_group_id"
								baseTableName="query_content"
								constraintName="fk_query_content_query_content_group_id"
								referencedColumnNames="id"
								referencedTableName="query_content_group"/>
	</changeSet>

    <changeSet id="create-query_content_participant" author="Henry">

        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="query_participant_content"/>
            </not>
        </preConditions>
        <createTable tableName="query_participant_content">
            <column name="id" type="bigint" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="subject_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="query_content_group_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="query_group_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>

            <column name="is_archived" type="BOOLEAN">
                <constraints nullable="false" />
            </column>


        </createTable>
        <addForeignKeyConstraint baseColumnNames="query_group_id"
                                 baseTableName="query_participant_content"
                                 constraintName="fk_query_participant_content_query_group_id"
                                 referencedColumnNames="id"
                                 referencedTableName="query_group"/>
        <addForeignKeyConstraint baseColumnNames="query_content_group_id"
                                 baseTableName="query_participant_content"
                                 constraintName="fk_query_participant_content_query_content_group_id"
                                 referencedColumnNames="id"
                                 referencedTableName="query_content_group"/>

        <addForeignKeyConstraint baseColumnNames="subject_id"
                                 baseTableName="query_participant_content"
                                 constraintName="fk_query_participant_content_subject_id"
                                 referencedColumnNames="id"
                                 referencedTableName="subject"/>

    </changeSet>

    <changeSet id="create-metric-averages" author="generated">
        <createTable tableName="metric_averages">
            <column name="id" type="bigint" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="subject_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="metric_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="value" type="DECIMAL(10, 2)">
                <constraints nullable="true" />
            </column>
            <column name="text_value" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="aggregation_type" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="aggregation_period" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="period_start_date" type="timestamp">
                <constraints nullable="false" />
            </column>
            <column name="period_end_date" type="timestamp">
                <constraints nullable="false" />
            </column>
            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>


        <!-- KEEPING THIS HERE AS LATER ON WE WILL PROBABLY NEED TO DECIDE WHAT INDEXES TO ADD -->
<!--       <createIndex tableName="metric_averages" indexName="idx_user_metric" unique="true">-->
<!--            <column name="subject_id" type="bigint"/>-->
<!--            <column name="metric_name" type="varchar(255)"/>-->
<!--        </createIndex>-->


<!--        <createIndex tableName="metric_averages" indexName="idx_period" unique="true">-->
<!--            <column name="period_start_date" type="timestamp"/>-->
<!--            <column name="aggregation_period" type="varchar(255)"/>-->
<!--        </createIndex>-->



        <addForeignKeyConstraint baseColumnNames="subject_id"
                                 baseTableName="metric_averages"
                                 constraintName="fk_metric_averages_subject_id"
                                 referencedColumnNames="id"
                                 referencedTableName="subject"/>
    </changeSet>


</databaseChangeLog>
